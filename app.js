$(document).ready(function() {
	var markers = [];
	var shadow = new google.maps.MarkerImage("./shadow.png",
        new google.maps.Size(44.0, 41.0),
        new google.maps.Point(0, 0),
        new google.maps.Point(11.0, 20.0)
    );
	function updateMarkers() {
		$.ajax({
			dataType : "json",
			url : './api/',
			data : null,
			timeout : 10000,
			error : function() {
				$('#counter').html('kein Netz');
				for (var key in markers) {
					markers[key].setMap(null);
					delete(markers[key]);
				}
				setTimeout(updateMarkers,1000);
			},
			success : function(_res) {
				var positions = _res.positions, simulation = _res.simulation;
				var found = false;
				for (var i=0;i<positions.length; i++) {
					var r = positions[i];
					if (!markers[r.nr]) {  // create new
						markers[r.nr] = new MarkerWithLabel({
       						position: new google.maps.LatLng(r.ll.split(',')[0],r.ll.split(',')[1]),
       						map: map,
      						shadow: shadow,
							labelContent: r.nr,
							//animation: google.maps.Animation.DROP,
       						labelAnchor: new google.maps.Point(12, 2),
       						labelClass: "labels", 
       						labelStyle: {opacity: 0.65},
       						icon: {url:'./rad.png'}
     					});
					} else {  // update of existing marker
						var lat = r.ll.split(',')[0], lon=r.ll.split(',')[1];
						if (simulation){
							var STEP = 0.001;
							var lat = markers[r.nr].getPosition().lat()  + Math.random()*STEP-STEP/2;
							var lon = markers[r.nr].getPosition().lng() + Math.random()*STEP-STEP/2;
											
						} 
						markers[r.nr].setPosition(new google.maps.LatLng(lat,lon));
					}
				}
				setTimeout(updateMarkers,2500);
				// kill old markers:
				$('#counter').html(positions.length+' Fahrer');
				for (var key in markers) {
					// looking for key in positions
					found = false;
					for (var i=0; i<positions.length; i++) {
						if (key == positions[i].nr) found = true;
					}
					if (found == false) {
						markers[key].setMap(null);
						delete(markers[key]);
					}
				}
				
			}
		});	
	}
	
    var map = new google.maps.Map(document.getElementById("map_canvas"), {
          center: new google.maps.LatLng(46.7049980,12.2289403),
          zoom: 11, disableDefaultUI: true,
          mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    var polylines = [];
    var routes = {"km_80": [ 
    			[46.7380528338253,12.1690098848194],[46.7382141016424,12.166181076318],[46.738900328055,12.1659058146179],[46.7396835330874,12.1591930836439],[46.7426986712962,12.1558046992868],[46.745874825865,12.1447696723044],[46.7460087686777,12.1464686840773],[46.7465816717595,12.1447752043605],[46.7465731222183,12.1411249693483],[46.7470380663872,12.1392548829317],[46.748533565551,12.1362862642854],[46.7488089110702,12.1339748706669],[46.749223312363,12.1348356921226],[46.7490714322776,12.1378148719668],[46.7494117375463,12.1391506958753],[46.7493427544832,12.1415145602077],[46.7497219517827,12.1428954787552],[46.749754557386,12.1416741516441],[46.7512303590775,12.1370518673211],[46.7512637190521,12.1340197138488],[46.751900576055,12.1315718628466],[46.7537309322506,12.1282975561917],[46.756464606151,12.1258929558098],[46.7569406982511,12.1265689563006],[46.7587712220848,12.1334670949727],[46.7584243789315,12.1353234350681],[46.7587179131806,12.1398689411581],[46.7585125565529,12.1411112230271],[46.7570689413697,12.1443984378129],[46.7573440354317,12.1452816389501],[46.756644481793,12.14769420214],[46.7569040693343,12.1520922705531],[46.7561812140048,12.1535031124949],[46.7576002702117,12.1573977638036],[46.7566186655313,12.163062337786],[46.7567307315767,12.1647816337645],[46.7576082330197,12.166215442121],[46.7572078295052,12.171310884878],[46.758351624012,12.1741013880819],[46.7573810834438,12.1763468161225],[46.7572846915573,12.1775422431529],[46.7582735884935,12.1819882560521],[46.7576341331005,12.1861801296473],[46.7579946387559,12.1873338986188],[46.7574026249349,12.1881475299597],[46.7581186909229,12.1887780167162],[46.7592489905655,12.1911228541285],[46.7595795728266,12.1932981256396],[46.7618033755571,12.1964520681649],[46.7627542186528,12.2011129092425],[46.763692740351,12.2034291643649],[46.763666421175,12.2048979252577],[46.7633427958935,12.205498656258],[46.7636473104358,12.207813737914],[46.7641630489379,12.2083586454391],[46.7640678305179,12.2094827424735],[46.7659982666373,12.215792555362],[46.7665931303054,12.2163809649646],[46.7683213949203,12.216088688001],[46.764329764992,12.2210361901671],[46.762437466532,12.2264420147985],[46.762503683567,12.2273701429367],[46.7614292073995,12.2318522818387],[46.7615669220686,12.2345100156963],[46.7607733234763,12.2366391029209],[46.7612344119698,12.2382845543325],[46.7607649415731,12.2394034545869],[46.7591356672347,12.2406868077815],[46.7573094181716,12.2403278108686],[46.7562763486058,12.2407944314182],[46.7560560721904,12.241684505716],[46.75716239959,12.2431426215917],[46.7577905394137,12.24615088664],[46.7586388718337,12.2465608455241],[46.7590684443712,12.2479079011828],[46.7590590566397,12.2515620756894],[46.7585563100874,12.2539543546736],[46.7589218448848,12.258704630658],[46.758755967021,12.2644120361656],[46.7585133109242,12.2648637369275],[46.7589438892901,12.2660318389535],[46.7589015606791,12.2692897170782],[46.75850501284,12.2695442754775],[46.7583475168794,12.2715020366013],[46.757550984621,12.2730803489685],[46.7568826116621,12.2767840605229],[46.7573364917189,12.2789087053388],[46.7552548460662,12.2869119141251],[46.7555721011013,12.2873295005411],[46.7552346456796,12.2962758410722],[46.7563704773784,12.2999948915094],[46.7603924497962,12.3037449549884],[46.7621482070535,12.3042391519994],[46.7621471174061,12.3053018935025],[46.7608073540032,12.3058400116861],[46.7586076911539,12.3041228111833],[46.7566118761897,12.3032764904201],[46.7557653039694,12.3024407308549],[46.7544735688716,12.3032581340522],[46.7535239830613,12.3045588377863],[46.7529297061265,12.3065967299044],[46.7533166147768,12.3068487737328],[46.75347821787,12.3082490544766],[46.7531364038587,12.3090954590589],[46.7531182151288,12.3111525457352],[46.7523844633251,12.3144511599094],[46.7524377722293,12.3160499241203],[46.7520450800657,12.3174226284027],[46.7522817011923,12.3182936757803],[46.7509055603296,12.3240693099797],[46.7501175776124,12.325225090608],[46.749889338389,12.3283933661878],[46.7492456082255,12.330410471186],[46.7486320529133,12.3307235352695],[46.7482207529247,12.3322558309883],[46.7485014628619,12.3339019529521],[46.7470835801214,12.3371227830648],[46.7455044295639,12.3384291864932],[46.7453492805362,12.3401858657598],[46.7432755976915,12.3437480069697],[46.7421093396842,12.3436149861664],[46.7403279338032,12.3417328298092],[46.7395203374326,12.3381579481065],[46.7392335925251,12.334282239899],[46.7383692506701,12.3323914501816],[46.738149644807,12.3304016701877],[46.7369978036731,12.3272804170847],[46.7354427929968,12.3260710760951],[46.7350962013006,12.3246852122247],[46.7342054564506,12.3239923641086],[46.734256753698,12.3247454781085],[46.7332121171057,12.32306859456],[46.7319144308567,12.3241128120571],[46.7318832501769,12.3252463806421],[46.7324082925916,12.3261992353946],[46.7314271070063,12.3267542850226],[46.7310692835599,12.3247417062521],[46.7294927313924,12.3252412676811],[46.7283768486232,12.3230726178735],[46.7274258378893,12.3179842159152],[46.7275784723461,12.3166214860976],[46.7279897723347,12.3164050653577],[46.7288208380342,12.310356432572],[46.7287263739854,12.303929021582],[46.72946523875,12.2999538201839],[46.7324496153742,12.2919466719031],[46.7309891525656,12.2914195340127],[46.730889659375,12.2884743846953],[46.7317480500787,12.2844456229359],[46.7306066863239,12.2844518255442],[46.7302013374865,12.2852739226073],[46.7299001757056,12.2850186936557],[46.7289134580642,12.2877450753003],[46.7283047642559,12.2873724158853],[46.7278369702399,12.286203308031],[46.7280121520162,12.2851228807122],[46.727023171261,12.2859703749418],[46.7262077797204,12.2890143468976],[46.7249458003789,12.290664492175],[46.7248556949198,12.2916010860354],[46.7229210678488,12.2935595177114],[46.7230074852705,12.2950123529881],[46.722007272765,12.2950639855117],[46.7218589968979,12.2977187857032],[46.7214593477547,12.2979598492384],[46.7213935498148,12.2987985424697],[46.7201129626483,12.3000365495682],[46.7206663358957,12.2988795116544],[46.7207342293113,12.2977810632437],[46.7202051635832,12.2967054136097],[46.7204842809588,12.2961495257914],[46.7200490087271,12.2946887277067],[46.7193161789328,12.2941179201007],[46.717551285401,12.2950917296112],[46.7170170228928,12.2941480949521],[46.7177807819098,12.2935546562076],[46.7172291688621,12.288954667747],[46.716684345156,12.2885584551841],[46.7164626438171,12.2872428316623],[46.7167903762311,12.2857453208417],[46.7152813822031,12.2831823863089],[46.7163010407239,12.2824344690889],[46.7169788852334,12.2826079744846],[46.7169104050845,12.2817735560238],[46.7164748813957,12.2813946940005],[46.7168771289289,12.2802703455091],[46.7178556323051,12.2795838676393],[46.7181815207005,12.2769483458251],[46.7195926140994,12.2765981499106],[46.7212747782469,12.2732320614159],[46.7212191224098,12.2726520337164],[46.7229892127216,12.272833334282],[46.7239244654775,12.2739287652075],[46.7243428900838,12.2730640042573],[46.724039465189,12.2698474489152],[46.7257217131555,12.2721188608557],[46.7266280483454,12.2751400340348],[46.7278908658773,12.2760943137109],[46.7282279022038,12.2770630940795],[46.728817904368,12.2746365331113],[46.7289458122104,12.2754427883774], 
    			 [46.7289458122104,12.2754427883774],[46.7294237483293,12.2737652342767],[46.7280613537878,12.2695339657366],[46.7277693282813,12.2675165254623],[46.7265987116843,12.2659039311111],[46.7254462838173,12.2650742065161],[46.724131917581,12.2615658771247],[46.7243791837245,12.2603520099074],[46.7239236272871,12.2572913579643],[46.7233596928418,12.256622062996],[46.7227428685874,12.2544078156352],[46.7224916629493,12.2513517737389],[46.726145921275,12.2487438283861],[46.7261844780296,12.2445112187415],[46.7241419758648,12.2315926942974],[46.7241516150534,12.2278260346502],[46.7250598780811,12.2219651564956],[46.7218958772719,12.2209575679153],[46.7189633846283,12.2233291435987],[46.7172625288367,12.2236006334424],[46.7156366072595,12.2229166701436],[46.7114424705505,12.2233516909182],[46.7096289619803,12.222822457552],[46.7071386985481,12.2201220598072],[46.7042731773108,12.2200118377805],[46.7028935998678,12.2213899902999],[46.7006626725197,12.2221957426518],[46.6972153633833,12.2213593125343],[46.6930424328893,12.2229034267366],[46.6923117823899,12.2237405274063],[46.6910109110177,12.2232625074685],[46.6887076478451,12.2233620006591],[46.6856576409191,12.2243929747492],[46.6832521185279,12.2244095709175],[46.6718912031502,12.2212486714125],[46.6719466913491,12.2215972747654],[46.6694481298327,12.2206878382713],[46.6640763357282,12.2229714877903],[46.6616969648749,12.2231785207987],[46.6591300070286,12.2250840626657],[46.656636307016,12.2252952028066],[46.6511287260801,12.2277191653848],[46.6496990248561,12.2288477886468],[46.6488090343773,12.2302831895649],[46.6454097535461,12.2328384965658],[46.6439351253211,12.2325645759702],[46.6424801945686,12.2332462761551],[46.6345677617937,12.2317429818213],[46.6322790831327,12.2297349292785],[46.6283149458468,12.2287984192371],[46.6227355320007,12.2241282742471],[46.6186859831214,12.2219572775066],[46.6157151013613,12.2241781465709],[46.6151547711343,12.2238002903759],[46.6140857432038,12.2252180054784],[46.6140602622181,12.226054854691],[46.6131396777928,12.226308491081],[46.6129883844405,12.2253752499819],[46.6124974563718,12.2249969746917],[46.6119784489274,12.2233183309436],[46.6121496073902,12.2227131575346],[46.611258527264,12.2194152977318],[46.6118327714503,12.2187464218587],[46.61382204853,12.2179516497999],[46.6141414828598,12.218194976449],[46.6178437694907,12.2165157459676],[46.6188370250165,12.2168542072177],[46.6191060841084,12.2159400768578],[46.6194716189057,12.2161002550274],[46.6201274190098,12.2139787953347],[46.6199264209718,12.2134678345174],[46.6202392335981,12.2110427822918],[46.6207246296108,12.2111818380654],[46.6211931779981,12.2104034107178],[46.6213343292475,12.2087721247226],[46.6222609486431,12.2067687660456],[46.6223730985075,12.2073206305504],[46.6215689387172,12.2089896351099],[46.6215884685516,12.2110216598958],[46.6212603170425,12.2121743392199],[46.6215644124895,12.2160242311656],[46.6234758216888,12.2077558189631],[46.6240032110363,12.2070591151714],[46.6235348302871,12.2081610001624],[46.6237636562437,12.2096266597509],[46.6233834531158,12.2116838302463],[46.6238573659211,12.2122942004353],[46.6234916634858,12.2150676045567],[46.6243229806423,12.2119787894189],[46.6242828313261,12.2103155683726],[46.624715924263,12.210171148181],[46.6261797398329,12.2072856780142],[46.6275769192725,12.2066712006927],[46.6263812407851,12.209338657558],[46.6289124079049,12.2076084651053],[46.630289722234,12.2049034573138],[46.6311752703041,12.203968456015],[46.6312934551388,12.2023608069867],[46.6318076848984,12.2009945567697],[46.6322007961571,12.2036304976791],[46.6316120512784,12.2054306790233],[46.6316786874086,12.2062143031508],[46.6337764263153,12.2031244821846],[46.6347696818411,12.2024668380618],[46.6359738260508,12.1996988821775],[46.6357476823032,12.1986349672079],[46.6365938354284,12.1982318814844],[46.6376036871225,12.1967603545636],[46.6393027827144,12.1962273493409],[46.6382867284119,12.1979121956974],[46.6383938491344,12.198891453445],[46.6392095759511,12.197744557634],[46.6401005722582,12.1975488401949],[46.6411986853927,12.1945299301296],[46.6442560683936,12.1937064919621],[46.6450692806393,12.1918349806219],[46.6460918728262,12.1909188386053],[46.6489334218204,12.1862775273621],[46.6530402190983,12.1818380523473],[46.6525202896446,12.1809162106365],[46.6530200187117,12.1795268263668],[46.6562378313392,12.1769164502621],[46.6572279855609,12.1728970762342],[46.6583407670259,12.1710160933435],[46.6602947562933,12.1714941132814],[46.66094946675,12.1709343697876],[46.6612435039133,12.1696940157562],[46.6617569793016,12.169566527009],[46.662281518802,12.1700968500227],[46.6640262119472,12.1680176351219],[46.6630442719907,12.1680267713964],[46.6627687588334,12.1673035807908],[46.6595099586993,12.1680347342044],[46.6606143582612,12.1669179294258],[46.6611409932375,12.1650646068156],[46.6625287011266,12.1651516947895],[46.6638745833188,12.1637881267816],[46.6653005965054,12.1637138631195],[46.6670525819063,12.1643981616944],[46.668093027547,12.1632120385766],[46.6670868638903,12.1638404298574],[46.666483618319,12.1630819514394],[46.6686191596091,12.1594450436532],[46.6693660710007,12.1574325487018],[46.6704380325973,12.1563054341823],[46.6705625038594,12.155453665182],[46.6711109317839,12.1552243363112],[46.6720280796289,12.1531563531607],[46.6716815717518,12.1524801012129],[46.6718730982393,12.1512875240296],[46.6729695349932,12.1491863485426],[46.6763290017843,12.1482740622014],[46.6782424226403,12.1488714404404],[46.6837842017412,12.1469459496439],[46.6854413878173,12.1470351330936],[46.6876889951527,12.1488778945059],[46.689740633592,12.1494003385305],[46.6914502903819,12.1486739628017],[46.6933634597808,12.1500208508223],[46.6956506296992,12.1495338622481],[46.6961736604571,12.1487412694842],[46.7001776956022,12.1502029057592],[46.7008051648736,12.1509985160083],[46.7018710914999,12.1511346381158],[46.7031695321202,12.1500361058861],[46.7062777094543,12.1501294802874],[46.707733143121,12.1492091473192],[46.7086036037654,12.1479995548725],[46.7106352932751,12.1466606296599],[46.7108559887856,12.1454200241715],[46.7130405642092,12.1432813815773],[46.7142128571868,12.1432141587138],[46.7149097286165,12.1409697365016],[46.7150232195854,12.1389468479902],[46.7154737468809,12.1382102463394],[46.7180722206831,12.1371935214847],[46.7180225998163,12.1376786660403],[46.7197129782289,12.1381478011608],[46.7237632814795,12.1413825452328],[46.7259704880416,12.1410763543099],[46.7265878990293,12.1428332850337],[46.729679480195,12.1454473491758],[46.7305853962898,12.1443479787558],[46.7334670946002,12.1449277549982],[46.7339161969721,12.1460094396025],[46.7354388535023,12.1473056171089],[46.7356597166508,12.1485306322575],[46.734735192731,12.1489452011883],[46.7365279141814,12.1506127808243],[46.7365487851202,12.1542109642178],[46.7358141951263,12.1567820291966],[46.7369589116424,12.1577781345695],[46.7368629388511,12.1635760646313],[46.7357875406742,12.1713094599545],[46.7359856888652,12.1733553986996],[46.736201941967,12.1724640671164],[46.7364786285907,12.1730193682015],[46.7370988894254,12.1717262919992],[46.7368634417653,12.1711702365428],[46.7380490619689,12.169241392985] 
				]};
	for (var key in routes) {
			var coords = [];
			for (var p=0;p<routes[key].length;p++) {
				var lat = routes[key][p][0];
				var lon = routes[key][p][1];
				coords[p] = new google.maps.LatLng(lat,lon);
			}
			polylines[key] = new google.maps.Polyline({
    			path : coords,
    			strokeColor: "#FF00FF",
    			strokeOpacity: 1.0,
    			strokeWeight: 5,
    			map : map
  			});
  			var path = polylines[key].getPath();
  			//console.log(google.maps.geometry.encoding.encodePath(path));

		
	}			             
	
    $('#map_canvas').animate({opacity:1},5000);
    updateMarkers();
    $('#navi img').bind('click',function(_e){
    	var key = $(this).attr('id');
    	if ($(this).hasClass('active')) {
    		$(this).fadeTo(200,1);
    		if (polylines[key]) polylines[key].setVisible(true)
    	} else {
    		$(this).fadeTo(200,.45);
    		if (polylines[key])  polylines[key].setVisible(false)
    	}	
    	$(this).toggleClass('active');
    })
});